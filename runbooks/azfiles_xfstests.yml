name: $(test_name)
include:
  - path: ../lisa/microsoft/runbook/tiers/tier.yml
variable:
  - name: test_name
    value: "azurefiles_xfstests"
  - name: subscription_id
    value: ""
  - name: location
    value: "centralindia"
  - name: keep_environment
    value: "always"
  - name: keep_build_env
    value: "always"
  - name: keep_test_env
    value: "failed"
  - name: builder_resource_group_name
    value: ""
  - name: resource_group_name
    value: "azfiles-lisa-rg"
  - name: marketplace_image
    value: "Canonical:ubuntu-24_04-lts:server:latest"
  - name: shared_gallery
    value: ""
  - name: community_gallery_image
    value: ""
  - name: vhd
    value: ""
  - name: builder_vm_size
    value: "Standard_D32alds_v6"
  - name: test_vm_name
    value: ""
  - name: vm_size
    value: ""
  - name: builder_deploy
    value: false
  - name: test_env_deploy
    value: true
  - name: wait_delete
    value: false
  - name: concurrency
    value: 1
  - name: admin_private_key_file
    value: ""
    is_secret: true
  - name: admin_password
    value: ""
    is_secret: true
  - name: azure_arm_access_token
    value: ""
    is_secret: true
  - name: auth_type
    value: "default"
  - name: use_ipv6
    value: false
  - name: test_case_name
    value: "verify_azure_file_share"
  - name: smb_mount_opts
    is_case_visible: true
    value: ""
  - name: addition_mount_opts
    is_case_visible: true
    value: ""
  - name: smb_testcases
    is_case_visible: true
    value: ""
  - name: azcopy_path
    value: ""
  - name: source_address_prefix
    value: ""
  - name: kernel_build
    value: false
  - name: build_vm_name
    value: "lisa-builder"
  - name: build_vm_address
    value: ""
  - name: upstream_tree_dir
    value: "/mnt/code"
  - name: upstream_repo
    value: ""
  - name: upstream_repo_ref
    value: "master"
  - name: src_dir_rel
    value: ""
  - name: src_repo
    value: ""
  - name: src_repo_ref
    value: ""
  - name: src_local_branch
    value: ""
  - name: kernel_pkg_dest
    value: "/default"
  - name: test_vm_kernel_path
    value: "/home/lisatest/kernels"
  - name: xfstests_repo
    is_case_visible: true
    value: ""
  - name: xfstests_branch
    is_case_visible: true
    value: ""
  - name: storage_account_name
    is_case_visible: true
    value: ""
  - name: file_share_urls
    is_case_visible: true
    value: []
  - name: enable_debpkg_transfer
    value: false
  - name: kernel_src_pkger_package_dir
    value: ""
  - name: kernel_src_pkger_packages
    value: []
  - name: file_transfer_local_path
    value: ""
  - name: file_transfer_transferred_files
    value: []
concurrency: $(concurrency)
notifier:
  - type: html
  - type: env_stats
  - type: console
  - type: lsg_database
    server: ""
    database: ""
    username: ""
    password: ""
    enabled: true
    azure_credential:
      type: default
      allow_all_tenants: true
platform:
  - type: azure
    admin_private_key_file: $(admin_private_key_file)
    admin_password: $(admin_password)
    keep_environment: $(keep_test_env)
    azure:
      credential:
        type: $(auth_type)
        token: $(azure_arm_access_token)
      resource_group_name: $(resource_group_name)
      deploy: $(test_env_deploy)
      subscription_id: $(subscription_id)
      wait_delete: $(wait_delete)
      azcopy_path: $(azcopy_path)
      use_ipv6: $(use_ipv6)
      source_address_prefixes:
        - $(source_address_prefix)
        - $(build_vm_address)
    requirement:
      azure:
        marketplace: $(marketplace_image)
        shared_gallery: $(shared_gallery)
        community_gallery_image: $(community_gallery_image)
        vhd: $(vhd)
        location: $(location)
        name: $(test_vm_name)
        vm_size: $(vm_size)
        osdisk_size_in_gb: 128
      core_count: 4
transformer:
  - type: azure_deploy
    name: builder_deploy
    resource_group_name: $(resource_group_name)
    source_address_prefixes:
      - $(source_address_prefix)
    private_key_file: $(admin_private_key_file)
    requirement:
      azure:
        marketplace: $(marketplace_image)
        shared_gallery: $(shared_gallery)
        community_gallery_image: $(community_gallery_image)
        vhd: $(vhd)
        name: $(build_vm_name)
        location: $(location)
        vm_size: $(builder_vm_size)
        osdisk_size_in_gb: 128
      # core_count: 16
    enabled: $(builder_deploy)
    keep_environment: $(keep_build_env)
    rename:
      builder_deploy_username: build_vm_username
      builder_deploy_address: build_vm_address
  - type: kernel_source_packager
    name: kernel_src_pkger
    connection:
      address: $(build_vm_address)
      private_key_file: $(admin_private_key_file)
    use_cache: true
    cache_destination: $(kernel_pkg_dest)
    location:
      type: worktree
      path: $(upstream_tree_dir)
      cleanup_code: false
      # repo: $(upstream_repo)
      ref: $(upstream_repo_ref)
      worktree_name: $(src_dir_rel)
      worktree_repo: $(src_repo)
      worktree_ref: $(src_repo_ref)
      worktree_local_branch: $(src_local_branch)
    enabled: $(kernel_build)
  - type: file_transfer
    phase: environment_connected
    enabled: $(enable_debpkg_transfer)
    source: $(kernel_src_pkger_package_dir)
    destination: $(test_vm_kernel_path)
    files: $(kernel_src_pkger_packages)
    try_scp: true
    source_node:
      type: remote
      user: "lisatest"
      address: $(build_vm_address)
      private_key_file: $(admin_private_key_file)
    local_path: $(file_transfer_local_path)
  - type: deb_package_installer
    depends_on:
      - file_transfer
    enabled: $(enable_debpkg_transfer)
    directory: $(test_vm_kernel_path)
    phase: environment_connected
    files: $(file_transfer_transferred_files)
    reboot: true
testcase:
  - criteria:
      name: $(test_case_name)
    #   priority: 0
    # enabled: true

# combinator:
#   type: batch
#   items:
#     - smb_testcases: "generic/001"
#       addition_mount_opts: ""
#       test_vm_name: "psachdeva-cifstest-vm"
#     - smb_testcases: "cifs/002"
#       addition_mount_opts: "closetimeo=30"
#       test_vm_name: "psachdeva-cifs-tester"
#       test_env_deploy: true
